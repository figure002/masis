\hypertarget{Database_8php}{\subsection{Database.\-php}
\label{Database_8php}\index{includes/\-Database.\-php@{includes/\-Database.\-php}}
}

\begin{DoxyCode}
00001 <?php
00002 
\hypertarget{Database_8php_source_l00006}{}\hyperlink{classDatabase}{00006} \textcolor{keyword}{class }\hyperlink{classDatabase}{Database} \{
\hypertarget{Database_8php_source_l00010}{}\hyperlink{classDatabase_af7c7304034efe8fd0b7f9d8b8ad63acc}{00010}     \textcolor{keyword}{public} \hyperlink{classDatabase_af7c7304034efe8fd0b7f9d8b8ad63acc}{$dbh} = null;
00011 
\hypertarget{Database_8php_source_l00015}{}\hyperlink{classDatabase_a502df1b3553fedfb4eb93788e9008294}{00015}     \textcolor{keyword}{public} \hyperlink{classDatabase_a502df1b3553fedfb4eb93788e9008294}{$aphia\_status\_exclude} = array(\textcolor{stringliteral}{'nomen dubium'},\textcolor{stringliteral}{'
      nomen nudum'},\textcolor{stringliteral}{'deleted'});
00016 
\hypertarget{Database_8php_source_l00020}{}\hyperlink{classDatabase_aac282092ecb7f4f3862af28726d18f6e}{00020}     \textcolor{keyword}{public} \hyperlink{classDatabase_aac282092ecb7f4f3862af28726d18f6e}{$tags\_image\_unusable} = array(\textcolor{stringliteral}{'unusable'},\textcolor{stringliteral}{'cannot
       see seafloor'},\textcolor{stringliteral}{'altitude too high'});
00021 
\hypertarget{Database_8php_source_l00025}{}\hyperlink{classDatabase_a27f4e88bfd7fcd348e0f544170fb2fbe}{00025}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a27f4e88bfd7fcd348e0f544170fb2fbe}{connect}() \{
00026         \textcolor{keywordflow}{try} \{
00027             $this->dbh = \textcolor{keyword}{new} PDO(\textcolor{stringliteral}{"pgsql:dbname="} . \hyperlink{classConfig_a05b671c1d9906d653dfab37fc5dc1588}{Config::read}(\textcolor{stringliteral}{'
      database'}) . \textcolor{stringliteral}{";host="} . \hyperlink{classConfig_a05b671c1d9906d653dfab37fc5dc1588}{Config::read}(\textcolor{stringliteral}{'hostname'}),
00028                 \hyperlink{classConfig_a05b671c1d9906d653dfab37fc5dc1588}{Config::read}(\textcolor{stringliteral}{'username'}),
00029                 \hyperlink{classConfig_a05b671c1d9906d653dfab37fc5dc1588}{Config::read}(\textcolor{stringliteral}{'password'}),
00030                 \hyperlink{classConfig_a05b671c1d9906d653dfab37fc5dc1588}{Config::read}(\textcolor{stringliteral}{'drivers'}));
00031         \}
00032         \textcolor{keywordflow}{catch} (PDOException $e) \{
00033             exit( \textcolor{stringliteral}{"Unable to connect: "} . $e->getMessage() );
00034         \}
00035 
00036         \textcolor{comment}{// Throw exceptions so errors can be handled gracefully.}
00037         $this->dbh->setAttribute( PDO::ATTR\_ERRMODE, PDO::ERRMODE\_EXCEPTION );
00038     \}
00039 
\hypertarget{Database_8php_source_l00048}{}\hyperlink{classDatabase_a18962b53bf38e115cfca934bd2d63d3b}{00048}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a18962b53bf38e115cfca934bd2d63d3b}{query}($query, $bind = null, $fetch = \textcolor{stringliteral}{'FETCH\_ASSOC'}) \{
00049         \textcolor{comment}{/* Prepare the query statement */}
00050         $this->sth = $this->dbh->prepare($query);
00051         \textcolor{comment}{/* Bind each value supplied from $bind */}
00052         \textcolor{keywordflow}{if} ($bind != null) \{
00053             \textcolor{keywordflow}{foreach}($bind as $select => $value) \{
00054                 \textcolor{comment}{/* For each type of value give the appropriate param */}
00055                 \textcolor{keywordflow}{if} (is\_int($value)) \{
00056                     $param = PDO::PARAM\_INT;
00057                 \} elseif (is\_bool($value)) \{
00058                     $param = PDO::PARAM\_BOOL;
00059                 \} elseif (is\_null($value)) \{
00060                     $param = PDO::PARAM\_NULL;
00061                 \} elseif (is\_string($value)) \{
00062                     $param = PDO::PARAM\_STR;
00063                 \} \textcolor{keywordflow}{else} \{
00064                     $param = FALSE;
00065                 \}
00066                 \textcolor{keywordflow}{if} ($param) \{
00067                     $this->sth->bindValue($select, $value, $param);
00068                 \}
00069             \}
00070         \}
00071 
00072         \textcolor{keywordflow}{if} (!$this->sth->execute())\{
00073             $result = array(
00074                 1 => \textcolor{stringliteral}{'false'},
00075                 2 => \textcolor{stringliteral}{'<b>[DATABASE] Error - Query:</b> There was an error in
       sql syntax'},
00076             );
00077             \textcolor{keywordflow}{return} $result;
00078         \}
00079 
00080         \textcolor{keywordflow}{if} ($fetch == \textcolor{stringliteral}{'FETCH\_ASSOC'}) \{
00081             $result = $this->sth->fetch(PDO::FETCH\_ASSOC);
00082         \}
00083         elseif ($fetch == \textcolor{stringliteral}{'FETCH\_BOTH'}) \{
00084             $result = $this->sth->fetch(PDO::FETCH\_BOTH);
00085         \}
00086         elseif ($fetch == \textcolor{stringliteral}{'FETCH\_LAZY'}) \{
00087             $result = $this->sth->fetch(PDO::FETCH\_LAZY);
00088         \}
00089         elseif ($fetch == \textcolor{stringliteral}{'FETCH\_OBJ'}) \{
00090             $result = $this->sth->fetch(PDO::FETCH\_OBJ);
00091         \}
00092         elseif ($fetch == \textcolor{stringliteral}{'fetchAll'}) \{
00093             $result = $this->sth->fetchAll();
00094         \}
00095         \textcolor{keywordflow}{return} $result;
00096     \}
00097 
\hypertarget{Database_8php_source_l00105}{}\hyperlink{classDatabase_af7bc1f009ae4cfec8a19ce4c1cc0a43a}{00105}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_af7bc1f009ae4cfec8a19ce4c1cc0a43a}{get\_image\_attributes}($dir, $filename) \{
00106         $filename = explode(\textcolor{charliteral}{'.'}, $filename);
00107         $filename = $filename[0] . \textcolor{stringliteral}{".%"};
00108 
00109         \textcolor{keywordflow}{try} \{
00110             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT i.id,}
00111 \textcolor{stringliteral}{                    i.img\_dir,}
00112 \textcolor{stringliteral}{                    i.file\_name,}
00113 \textcolor{stringliteral}{                    i.event\_id,}
00114 \textcolor{stringliteral}{                    i.mission\_id,}
00115 \textcolor{stringliteral}{                    i.longitude,}
00116 \textcolor{stringliteral}{                    i.latitude,}
00117 \textcolor{stringliteral}{                    i.timestamp,}
00118 \textcolor{stringliteral}{                    i.nav\_depth AS depth,}
00119 \textcolor{stringliteral}{                    i.nav\_altitude AS altitude,}
00120 \textcolor{stringliteral}{                    i.img\_area AS area,}
00121 \textcolor{stringliteral}{                    i.temperature,}
00122 \textcolor{stringliteral}{                    i.salinity,}
00123 \textcolor{stringliteral}{                    a.annotation\_status}
00124 \textcolor{stringliteral}{                FROM image\_info i}
00125 \textcolor{stringliteral}{                    LEFT OUTER JOIN image\_annotation\_status a ON
       a.image\_info\_id = i.id}
00126 \textcolor{stringliteral}{                WHERE i.img\_dir = :dir}
00127 \textcolor{stringliteral}{                    AND i.file\_name SIMILAR TO :filename;"});
00128             $sth->bindParam(\textcolor{stringliteral}{":dir"}, $dir, PDO::PARAM\_STR);
00129             $sth->bindParam(\textcolor{stringliteral}{":filename"}, $filename, PDO::PARAM\_STR);
00130             $sth->execute();
00131         \}
00132         \textcolor{keywordflow}{catch} (Exception $e) \{
00133             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00134         \}
00135         \textcolor{keywordflow}{return} $sth->fetch(PDO::FETCH\_ASSOC);
00136     \}
00137 
\hypertarget{Database_8php_source_l00150}{}\hyperlink{classDatabase_a6cf70f0c423b4b32d9b2825c74152da4}{00150}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a6cf70f0c423b4b32d9b2825c74152da4}{get\_files\_for\_dir}($dir) \{
00151         \textcolor{keywordflow}{try} \{
00152             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT i.file\_name,}
00153 \textcolor{stringliteral}{                    a.annotation\_status,}
00154 \textcolor{stringliteral}{                    COUNT(v.id) AS n\_vectors,}
00155 \textcolor{stringliteral}{                    -- This boolean tells whether the substrate is annotated}
00156 \textcolor{stringliteral}{                    (SELECT 1 FROM image\_substrate WHERE image\_info\_id = i.id
       LIMIT 1) AS substrate\_annotated,}
00157 \textcolor{stringliteral}{                    -- Get comma separated list of image tags.}
00158 \textcolor{stringliteral}{                    (SELECT STRING\_AGG(image\_tag, ',') FROM image\_tags WHERE
       image\_info\_id = i.id) AS tags}
00159 \textcolor{stringliteral}{                FROM image\_info i}
00160 \textcolor{stringliteral}{                    LEFT OUTER JOIN vectors v ON v.image\_info\_id = i.id}
00161 \textcolor{stringliteral}{                    LEFT OUTER JOIN image\_annotation\_status a ON
       a.image\_info\_id = i.id}
00162 \textcolor{stringliteral}{                WHERE i.img\_dir = :dir}
00163 \textcolor{stringliteral}{                GROUP BY i.id, i.file\_name, a.annotation\_status}
00164 \textcolor{stringliteral}{                ORDER BY i.timestamp, i.file\_name;"});
00165             $sth->bindParam(\textcolor{stringliteral}{":dir"}, $dir, PDO::PARAM\_STR);
00166             $sth->execute();
00167         \}
00168         \textcolor{keywordflow}{catch} (Exception $e) \{
00169             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00170         \}
00171         \textcolor{keywordflow}{return} $sth;
00172     \}
00173 
\hypertarget{Database_8php_source_l00180}{}\hyperlink{classDatabase_a0fa69e8599adb5307cfc552ac9bf2c0d}{00180}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a0fa69e8599adb5307cfc552ac9bf2c0d}{cache\_aphia\_records}($records, $update=\textcolor{keyword}{
      true}) \{
00181         \textcolor{comment}{// Begin a database transaction.}
00182         $this->dbh->beginTransaction();
00183 
00184         \textcolor{keywordflow}{foreach} ($records as $sp) \{
00185             \textcolor{comment}{// Skip Aphia records with a specific status.}
00186             \textcolor{keywordflow}{if} ( in\_array($sp->status, $this->aphia\_status\_exclude) ) \textcolor{keywordflow}{continue};
00187 
00188             \textcolor{comment}{// Check if this record already exists in the database.}
00189             \textcolor{keywordflow}{try} \{
00190                 $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT aphia\_id FROM species}
00191 \textcolor{stringliteral}{                    WHERE aphia\_id = :aphia\_id;"});
00192                 $sth->bindParam(\textcolor{stringliteral}{":aphia\_id"}, $sp->AphiaID, PDO::PARAM\_INT);
00193                 $sth->execute();
00194             \}
00195             \textcolor{keywordflow}{catch} (Exception $e) \{
00196                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00197             \}
00198             $row = $sth->fetch();
00199             $aphia\_id = $row ? $row[0] : NULL;
00200 
00201             \textcolor{comment}{// Cache or update the record.}
00202             $query = NULL;
00203             \textcolor{keywordflow}{if} ( is\_null($aphia\_id) ) \{
00204                 $query = \textcolor{stringliteral}{"INSERT INTO species (}
00205 \textcolor{stringliteral}{                        aphia\_id,}
00206 \textcolor{stringliteral}{                        lsid,}
00207 \textcolor{stringliteral}{                        scientific\_name,}
00208 \textcolor{stringliteral}{                        status,}
00209 \textcolor{stringliteral}{                        valid\_aphia\_id,}
00210 \textcolor{stringliteral}{                        valid\_name,}
00211 \textcolor{stringliteral}{                        kingdom,}
00212 \textcolor{stringliteral}{                        phylum,}
00213 \textcolor{stringliteral}{                        class,}
00214 \textcolor{stringliteral}{                        \(\backslash\)"order\(\backslash\)",}
00215 \textcolor{stringliteral}{                        family,}
00216 \textcolor{stringliteral}{                        genus}
00217 \textcolor{stringliteral}{                        )}
00218 \textcolor{stringliteral}{                    VALUES (}
00219 \textcolor{stringliteral}{                        :aphia\_id,}
00220 \textcolor{stringliteral}{                        :lsid,}
00221 \textcolor{stringliteral}{                        :scientific\_name,}
00222 \textcolor{stringliteral}{                        :status,}
00223 \textcolor{stringliteral}{                        :valid\_aphia\_id,}
00224 \textcolor{stringliteral}{                        :valid\_name,}
00225 \textcolor{stringliteral}{                        :kingdom,}
00226 \textcolor{stringliteral}{                        :phylum,}
00227 \textcolor{stringliteral}{                        :class,}
00228 \textcolor{stringliteral}{                        :order,}
00229 \textcolor{stringliteral}{                        :family,}
00230 \textcolor{stringliteral}{                        :genus);"};
00231             \}
00232             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ($update) \{
00233                 $query = \textcolor{stringliteral}{"UPDATE species SET (}
00234 \textcolor{stringliteral}{                        lsid,}
00235 \textcolor{stringliteral}{                        scientific\_name,}
00236 \textcolor{stringliteral}{                        status,}
00237 \textcolor{stringliteral}{                        valid\_aphia\_id,}
00238 \textcolor{stringliteral}{                        valid\_name,}
00239 \textcolor{stringliteral}{                        kingdom,}
00240 \textcolor{stringliteral}{                        phylum,}
00241 \textcolor{stringliteral}{                        class,}
00242 \textcolor{stringliteral}{                        \(\backslash\)"order\(\backslash\)",}
00243 \textcolor{stringliteral}{                        family,}
00244 \textcolor{stringliteral}{                        genus}
00245 \textcolor{stringliteral}{                    ) = (}
00246 \textcolor{stringliteral}{                        :lsid,}
00247 \textcolor{stringliteral}{                        :scientific\_name,}
00248 \textcolor{stringliteral}{                        :status,}
00249 \textcolor{stringliteral}{                        :valid\_aphia\_id,}
00250 \textcolor{stringliteral}{                        :valid\_name,}
00251 \textcolor{stringliteral}{                        :kingdom,}
00252 \textcolor{stringliteral}{                        :phylum,}
00253 \textcolor{stringliteral}{                        :class,}
00254 \textcolor{stringliteral}{                        :order,}
00255 \textcolor{stringliteral}{                        :family,}
00256 \textcolor{stringliteral}{                        :genus)}
00257 \textcolor{stringliteral}{                    WHERE aphia\_id = :aphia\_id;"};
00258             \}
00259 
00260             \textcolor{keywordflow}{if} (!$query) \textcolor{keywordflow}{continue};
00261 
00262             \textcolor{keywordflow}{try} \{
00263                 $sth = $this->dbh->prepare($query);
00264                 $sth->bindParam(\textcolor{stringliteral}{":aphia\_id"}, $sp->AphiaID, PDO::PARAM\_INT);
00265                 $sth->bindParam(\textcolor{stringliteral}{":lsid"}, $sp->lsid, PDO::PARAM\_STR);
00266                 $sth->bindParam(\textcolor{stringliteral}{":scientific\_name"}, $sp->scientificname, 
      PDO::PARAM\_STR);
00267                 $sth->bindParam(\textcolor{stringliteral}{":status"}, $sp->status, PDO::PARAM\_STR);
00268                 $sth->bindParam(\textcolor{stringliteral}{":valid\_aphia\_id"}, $sp->valid\_AphiaID, 
      PDO::PARAM\_INT);
00269                 $sth->bindParam(\textcolor{stringliteral}{":valid\_name"}, $sp->valid\_name, PDO::PARAM\_STR)
      ;
00270                 $sth->bindParam(\textcolor{stringliteral}{":kingdom"}, $sp->kingdom, PDO::PARAM\_STR);
00271                 $sth->bindParam(\textcolor{stringliteral}{":phylum"}, $sp->phylum, PDO::PARAM\_STR);
00272                 $sth->bindParam(\textcolor{stringliteral}{":class"}, $sp->class, PDO::PARAM\_STR);
00273                 $sth->bindParam(\textcolor{stringliteral}{":order"}, $sp->order, PDO::PARAM\_STR);
00274                 $sth->bindParam(\textcolor{stringliteral}{":family"}, $sp->family, PDO::PARAM\_STR);
00275                 $sth->bindParam(\textcolor{stringliteral}{":genus"}, $sp->genus, PDO::PARAM\_STR);
00276                 $sth->execute();
00277             \}
00278             \textcolor{keywordflow}{catch} (Exception $e) \{
00279                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00280             \}
00281         \}
00282 
00283         \textcolor{comment}{// Commit the transaction.}
00284         $this->dbh->commit();
00285     \}
00286 
\hypertarget{Database_8php_source_l00296}{}\hyperlink{classDatabase_a5972a2838b98ed0b7816a528ac823bec}{00296}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a5972a2838b98ed0b7816a528ac823bec}{get\_species\_matching}($term, $limit=20) 
      \{
00297         \textcolor{keywordflow}{try} \{
00298             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT * FROM species}
00299 \textcolor{stringliteral}{                WHERE scientific\_name ~* :term}
00300 \textcolor{stringliteral}{                ORDER BY scientific\_name}
00301 \textcolor{stringliteral}{                LIMIT :limit;"});
00302             $sth->bindParam(\textcolor{stringliteral}{":term"}, $term, PDO::PARAM\_STR);
00303             $sth->bindParam(\textcolor{stringliteral}{":limit"}, $limit, PDO::PARAM\_INT);
00304             $sth->execute();
00305         \}
00306         \textcolor{keywordflow}{catch} (Exception $e) \{
00307             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00308         \}
00309         \textcolor{keywordflow}{return} $sth;
00310     \}
00311 
\hypertarget{Database_8php_source_l00317}{}\hyperlink{classDatabase_a9549b0da67a3ad1f6e2f569d67e107ec}{00317}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a9549b0da67a3ad1f6e2f569d67e107ec}{get\_substrate\_types}() \{
00318         \textcolor{keywordflow}{try} \{
00319             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT name FROM substrate\_types ORDER
       BY name;"});
00320             $sth->execute();
00321         \}
00322         \textcolor{keywordflow}{catch} (Exception $e) \{
00323             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00324         \}
00325         \textcolor{keywordflow}{return} $sth;
00326     \}
00327 
\hypertarget{Database_8php_source_l00333}{}\hyperlink{classDatabase_a9470debaa4dbabb3fb87f48c8bece98b}{00333}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a9470debaa4dbabb3fb87f48c8bece98b}{get\_image\_tag\_types}() \{
00334         \textcolor{keywordflow}{try} \{
00335             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT name FROM image\_tag\_types ORDER
       BY name;"});
00336             $sth->execute();
00337         \}
00338         \textcolor{keywordflow}{catch} (Exception $e) \{
00339             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00340         \}
00341         \textcolor{keywordflow}{return} $sth;
00342     \}
00343 
\hypertarget{Database_8php_source_l00350}{}\hyperlink{classDatabase_a231a45ee6f3292841b5b1272d5fac725}{00350}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a231a45ee6f3292841b5b1272d5fac725}{get\_vectors}($image\_id) \{
00351         \textcolor{keywordflow}{try} \{
00352             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT v.vector\_id,}
00353 \textcolor{stringliteral}{                v.vector\_wkt,}
00354 \textcolor{stringliteral}{                v.aphia\_id,}
00355 \textcolor{stringliteral}{                s.scientific\_name}
00356 \textcolor{stringliteral}{            FROM vectors v}
00357 \textcolor{stringliteral}{                -- OUTER JOIN because unassigned vectors should be returned}
00358 \textcolor{stringliteral}{                -- as well}
00359 \textcolor{stringliteral}{                LEFT OUTER JOIN species s ON v.aphia\_id = s.aphia\_id}
00360 \textcolor{stringliteral}{            WHERE v.image\_info\_id = :image\_id;"});
00361             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00362             $sth->execute();
00363         \}
00364         \textcolor{keywordflow}{catch} (Exception $e) \{
00365             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00366         \}
00367         \textcolor{keywordflow}{return} $sth;
00368     \}
00369 
\hypertarget{Database_8php_source_l00376}{}\hyperlink{classDatabase_a9cbb05bd40bab06c6d1900b9e1905613}{00376}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a9cbb05bd40bab06c6d1900b9e1905613}{save\_vectors}($vectors) \{
00377         global $member;
00378 
00379         \textcolor{comment}{// Get user info.}
00380         $user = $member->data();
00381 
00382         \textcolor{comment}{// Start a database transaction.}
00383         $this->dbh->beginTransaction();
00384 
00385         \textcolor{keywordflow}{foreach} ($vectors as $i => $vector) \{
00386             \textcolor{comment}{// Check if this particular vector already exists in the database.}
00387             \textcolor{keywordflow}{try} \{
00388                 $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT id FROM vectors}
00389 \textcolor{stringliteral}{                    WHERE image\_info\_id = :image\_id}
00390 \textcolor{stringliteral}{                        AND vector\_id = :vector\_id;"});
00391                 $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $vector[\textcolor{stringliteral}{'image\_id'}], 
      PDO::PARAM\_INT);
00392                 $sth->bindParam(\textcolor{stringliteral}{":vector\_id"}, $vector[\textcolor{stringliteral}{'id'}], PDO::PARAM\_STR);
00393                 $sth->execute();
00394             \}
00395             \textcolor{keywordflow}{catch} (Exception $e) \{
00396                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00397             \}
00398             $row = $sth->fetch();
00399             $vector\_id = $row ? $row[0] : NULL;
00400 
00401             \textcolor{comment}{// Handle vectors not assigned to a species.}
00402             \textcolor{comment}{// The ( !is\_int() && !ctype\_digit() ) part is for checking numeric}
00403             \textcolor{comment}{// strings.}
00404             \textcolor{keywordflow}{if} ( !isset($vector[\textcolor{stringliteral}{'aphia\_id'}]) || ( !is\_int($vector[\textcolor{stringliteral}{'aphia\_id'}]) 
      && !ctype\_digit($vector[\textcolor{stringliteral}{'aphia\_id'}]) ) ) \{
00405                 $vector[\textcolor{stringliteral}{'aphia\_id'}] = NULL;
00406                 $vector[\textcolor{stringliteral}{'species\_name'}] = NULL;
00407             \}
00408 
00409             \textcolor{comment}{// Save or update vector.}
00410             \textcolor{keywordflow}{if} ( is\_null($vector\_id) ) \{
00411                 $query = \textcolor{stringliteral}{"INSERT INTO vectors (}
00412 \textcolor{stringliteral}{                        image\_info\_id,}
00413 \textcolor{stringliteral}{                        aphia\_id,}
00414 \textcolor{stringliteral}{                        vector\_id,}
00415 \textcolor{stringliteral}{                        vector\_wkt,}
00416 \textcolor{stringliteral}{                        area\_pixels,}
00417 \textcolor{stringliteral}{                        area\_m2,}
00418 \textcolor{stringliteral}{                        created\_by,}
00419 \textcolor{stringliteral}{                        remarks)}
00420 \textcolor{stringliteral}{                    VALUES (}
00421 \textcolor{stringliteral}{                        :image\_id,}
00422 \textcolor{stringliteral}{                        :aphia\_id,}
00423 \textcolor{stringliteral}{                        :id,}
00424 \textcolor{stringliteral}{                        :vector\_wkt,}
00425 \textcolor{stringliteral}{                        :area\_pixels,}
00426 \textcolor{stringliteral}{                        :area\_m2,}
00427 \textcolor{stringliteral}{                        :user\_id,}
00428 \textcolor{stringliteral}{                        :species\_name);"};
00429             \}
00430             \textcolor{keywordflow}{else} \{
00431                 $query = \textcolor{stringliteral}{"UPDATE vectors SET (}
00432 \textcolor{stringliteral}{                        aphia\_id,}
00433 \textcolor{stringliteral}{                        vector\_wkt,}
00434 \textcolor{stringliteral}{                        area\_pixels,}
00435 \textcolor{stringliteral}{                        area\_m2,}
00436 \textcolor{stringliteral}{                        updated\_by,}
00437 \textcolor{stringliteral}{                        updated\_on,}
00438 \textcolor{stringliteral}{                        remarks}
00439 \textcolor{stringliteral}{                    ) = (}
00440 \textcolor{stringliteral}{                        :aphia\_id,}
00441 \textcolor{stringliteral}{                        :vector\_wkt,}
00442 \textcolor{stringliteral}{                        :area\_pixels,}
00443 \textcolor{stringliteral}{                        :area\_m2,}
00444 \textcolor{stringliteral}{                        :user\_id,}
00445 \textcolor{stringliteral}{                        NOW(),}
00446 \textcolor{stringliteral}{                        :species\_name)}
00447 \textcolor{stringliteral}{                    WHERE image\_info\_id = :image\_id}
00448 \textcolor{stringliteral}{                        AND vector\_id = :id;"};
00449             \}
00450             \textcolor{keywordflow}{try} \{
00451                 $sth = $this->dbh->prepare($query);
00452                 $sth->bindParam(\textcolor{stringliteral}{":id"}, $vector[\textcolor{stringliteral}{'id'}], PDO::PARAM\_STR);
00453                 $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $vector[\textcolor{stringliteral}{'image\_id'}], 
      PDO::PARAM\_INT);
00454                 $sth->bindParam(\textcolor{stringliteral}{":aphia\_id"}, $vector[\textcolor{stringliteral}{'aphia\_id'}], 
      PDO::PARAM\_INT);
00455                 $sth->bindParam(\textcolor{stringliteral}{":vector\_wkt"}, $vector[\textcolor{stringliteral}{'vector\_wkt'}], 
      PDO::PARAM\_STR);
00456                 $sth->bindParam(\textcolor{stringliteral}{":area\_pixels"}, $vector[\textcolor{stringliteral}{'area\_pixels'}], 
      PDO::PARAM\_INT);
00457                 $sth->bindParam(\textcolor{stringliteral}{":area\_m2"}, $vector[\textcolor{stringliteral}{'area\_m2'}], PDO::PARAM\_STR)
      ;
00458                 $sth->bindParam(\textcolor{stringliteral}{":user\_id"}, $user->id, PDO::PARAM\_STR);
00459                 $sth->bindParam(\textcolor{stringliteral}{":species\_name"}, $vector[\textcolor{stringliteral}{'species\_name'}], 
      PDO::PARAM\_STR);
00460                 $sth->execute();
00461             \}
00462             \textcolor{keywordflow}{catch} (Exception $e) \{
00463                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00464             \}
00465         \}
00466 
00467         \textcolor{comment}{// Commit the transaction.}
00468         $this->dbh->commit();
00469     \}
00470 
\hypertarget{Database_8php_source_l00477}{}\hyperlink{classDatabase_a764fbabef33fae2ff24290462d954a99}{00477}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a764fbabef33fae2ff24290462d954a99}{delete\_vector}($image\_id, $vector\_id) \{
00478         \textcolor{keywordflow}{try} \{
00479             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"DELETE FROM vectors}
00480 \textcolor{stringliteral}{            WHERE image\_info\_id = :image\_id}
00481 \textcolor{stringliteral}{                AND vector\_id = :vector\_id;"});
00482             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00483             $sth->bindParam(\textcolor{stringliteral}{":vector\_id"}, $vector\_id, PDO::PARAM\_STR);
00484             $sth->execute();
00485         \}
00486         \textcolor{keywordflow}{catch} (Exception $e) \{
00487             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00488         \}
00489     \}
00490 
\hypertarget{Database_8php_source_l00500}{}\hyperlink{classDatabase_a0fba6ad55208137b25381d4b73954c2c}{00500}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a0fba6ad55208137b25381d4b73954c2c}{set\_areas\_image\_grouped}() \{
00501         \textcolor{comment}{// Start a database transaction.}
00502         $this->dbh->beginTransaction();
00503 
00504         \textcolor{keywordflow}{try} \{
00505             $sth = $this->dbh->exec(\textcolor{stringliteral}{"TRUNCATE areas\_image\_grouped;"});
00506         \}
00507         \textcolor{keywordflow}{catch} (Exception $e) \{
00508             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00509         \}
00510 
00511         \textcolor{keywordflow}{try} \{
00512             $sth = $this->dbh->exec(\textcolor{stringliteral}{"INSERT INTO areas\_image\_grouped
       (image\_info\_id,aphia\_id,vector\_count,species\_area,image\_area)}
00513 \textcolor{stringliteral}{                SELECT i.id,}
00514 \textcolor{stringliteral}{                    s.aphia\_id,}
00515 \textcolor{stringliteral}{                    count(v.id),}
00516 \textcolor{stringliteral}{                    sum(v.area\_m2),}
00517 \textcolor{stringliteral}{                    i.img\_area}
00518 \textcolor{stringliteral}{                FROM vectors v}
00519 \textcolor{stringliteral}{                    INNER JOIN species s ON s.aphia\_id = v.aphia\_id}
00520 \textcolor{stringliteral}{                    INNER JOIN image\_info i ON i.id = v.image\_info\_id}
00521 \textcolor{stringliteral}{                GROUP BY i.id, s.aphia\_id;"});
00522         \}
00523         \textcolor{keywordflow}{catch} (Exception $e) \{
00524             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00525         \}
00526 
00527         \textcolor{comment}{// Commit the transaction.}
00528         $this->dbh->commit();
00529     \}
00530 
\hypertarget{Database_8php_source_l00537}{}\hyperlink{classDatabase_afa6f84f0b79f0be0b4a81e9898c2b3e7}{00537}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_afa6f84f0b79f0be0b4a81e9898c2b3e7}{set\_areas}() \{
00538         \textcolor{keywordflow}{try} \{
00539             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT id, altitude FROM image\_info}
00540 \textcolor{stringliteral}{                WHERE area IS NULL;"});
00541             $sth->execute();
00542         \}
00543         \textcolor{keywordflow}{catch} (Exception $e) \{
00544             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00545         \}
00546 
00547         \textcolor{comment}{// Start a database transaction.}
00548         $this->dbh->beginTransaction();
00549 
00550         $count = 0;
00551         \textcolor{keywordflow}{while} ( $row = $sth->fetch(PDO::FETCH\_ASSOC) ) \{
00552             $area = MaSIS::get\_area\_from\_altitude($row[\textcolor{stringliteral}{'altitude'}]);
00553 
00554             \textcolor{keywordflow}{try} \{
00555                 $sth2 = $this->dbh->prepare(\textcolor{stringliteral}{"UPDATE image\_info SET area = :area}
00556 \textcolor{stringliteral}{                    WHERE id = :id;"});
00557                 $sth2->bindParam(\textcolor{stringliteral}{":area"}, $area, PDO::PARAM\_STR);
00558                 $sth2->bindParam(\textcolor{stringliteral}{":id"}, $row[\textcolor{stringliteral}{'id'}], PDO::PARAM\_INT);
00559                 $sth2->execute();
00560             \}
00561             \textcolor{keywordflow}{catch} (Exception $e) \{
00562                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00563             \}
00564             $count++;
00565         \}
00566 
00567         \textcolor{comment}{// Commit the transaction.}
00568         $this->dbh->commit();
00569         \textcolor{keywordflow}{return} $count;
00570     \}
00571 
\hypertarget{Database_8php_source_l00578}{}\hyperlink{classDatabase_a4e89aa8e1053f8753a22572f65e0d2be}{00578}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a4e89aa8e1053f8753a22572f65e0d2be}{set\_annotation\_status}($image\_id, 
      $status) \{
00579         \textcolor{keywordflow}{try} \{
00580             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT annotation\_status}
00581 \textcolor{stringliteral}{                FROM image\_annotation\_status WHERE image\_info\_id = :image\_id;"})
      ;
00582             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00583             $sth->execute();
00584         \}
00585         \textcolor{keywordflow}{catch} (Exception $e) \{
00586             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00587         \}
00588         $row = $sth->fetch();
00589         $annotation\_status = $row ? $row[0] : NULL;
00590 
00591         \textcolor{comment}{// If the status is already set to the same value, do nothing.}
00592         \textcolor{keywordflow}{if} ($annotation\_status == $status) \textcolor{keywordflow}{return};
00593 
00594         \textcolor{comment}{// Set the new record or update the existing.}
00595         \textcolor{keywordflow}{if} ($annotation\_status == NULL) \{
00596             $query = \textcolor{stringliteral}{"INSERT INTO image\_annotation\_status VALUES (:image\_id,
       :status);"};
00597         \}
00598         \textcolor{keywordflow}{else} \{
00599             $query = \textcolor{stringliteral}{"UPDATE image\_annotation\_status SET annotation\_status =
       :status}
00600 \textcolor{stringliteral}{                WHERE image\_info\_id = :image\_id;"};
00601         \}
00602         \textcolor{keywordflow}{try} \{
00603             $sth = $this->dbh->prepare($query);
00604             $sth->bindParam(\textcolor{stringliteral}{":status"}, $status, PDO::PARAM\_STR);
00605             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00606             $sth->execute();
00607         \}
00608         \textcolor{keywordflow}{catch} (Exception $e) \{
00609             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00610         \}
00611     \}
00612 
\hypertarget{Database_8php_source_l00619}{}\hyperlink{classDatabase_adf48d605dd4622b07cc9a7f548cc5917}{00619}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_adf48d605dd4622b07cc9a7f548cc5917}{get\_substrate\_annotations}(
      $image\_id) \{
00620         \textcolor{keywordflow}{try} \{
00621             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT substrate\_type, dominance}
00622 \textcolor{stringliteral}{                FROM image\_substrate}
00623 \textcolor{stringliteral}{                WHERE image\_info\_id = :image\_id;"});
00624             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00625             $sth->execute();
00626         \}
00627         \textcolor{keywordflow}{catch} (Exception $e) \{
00628             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00629         \}
00630         \textcolor{keywordflow}{return} $sth;
00631     \}
00632 
\hypertarget{Database_8php_source_l00639}{}\hyperlink{classDatabase_a1e9b6dcb97dbec39092dc887db9242b2}{00639}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a1e9b6dcb97dbec39092dc887db9242b2}{get\_image\_tags}($image\_id) \{
00640         \textcolor{keywordflow}{try} \{
00641             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"SELECT image\_tag}
00642 \textcolor{stringliteral}{                FROM image\_tags}
00643 \textcolor{stringliteral}{                WHERE image\_info\_id = :image\_id;"});
00644             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00645             $sth->execute();
00646         \}
00647         \textcolor{keywordflow}{catch} (Exception $e) \{
00648             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00649         \}
00650         \textcolor{keywordflow}{return} $sth;
00651     \}
00652 
\hypertarget{Database_8php_source_l00661}{}\hyperlink{classDatabase_a241720daf5ac8d79ce1283898c0a7da3}{00661}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a241720daf5ac8d79ce1283898c0a7da3}{set\_substrate\_annotations}(
      $image\_id, $annotations) \{
00662         \textcolor{comment}{// Start a database transaction.}
00663         $this->dbh->beginTransaction();
00664 
00665         \textcolor{comment}{// Delete all substrate annotations for this image.}
00666         \textcolor{keywordflow}{try} \{
00667             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"DELETE FROM image\_substrate WHERE
       image\_info\_id = :image\_id;"});
00668             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00669             $sth->execute();
00670         \}
00671         \textcolor{keywordflow}{catch} (Exception $e) \{
00672             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00673         \}
00674 
00675         \textcolor{comment}{// Set the new substrate annotations.}
00676         \textcolor{keywordflow}{foreach} ( $annotations as $dominance => $substrates ) \{
00677             \textcolor{comment}{// Check if the dominance is set ok.}
00678             \textcolor{keywordflow}{if} ( !in\_array($dominance, array(\textcolor{stringliteral}{'dominant'},\textcolor{stringliteral}{'subdominant'})) ) \{
00679                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception(\textcolor{stringliteral}{"Invalid dominance type. Must be 'dominant'
       or 'subdominant', but got '\{$dominance\}'."});
00680             \}
00681 
00682             \textcolor{keywordflow}{foreach} ( $substrates as $substrate\_type ) \{
00683                 \textcolor{keywordflow}{try} \{
00684                     $sth = $this->dbh->prepare(\textcolor{stringliteral}{"INSERT INTO image\_substrate
       VALUES (:image\_id, :substrate\_type, :dominance);"});
00685                     $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00686                     $sth->bindParam(\textcolor{stringliteral}{":substrate\_type"}, $substrate\_type, 
      PDO::PARAM\_INT);
00687                     $sth->bindParam(\textcolor{stringliteral}{":dominance"}, $dominance, PDO::PARAM\_STR);
00688                     $sth->execute();
00689                 \}
00690                 \textcolor{keywordflow}{catch} (Exception $e) \{
00691                     \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00692                 \}
00693             \}
00694         \}
00695 
00696         \textcolor{comment}{// Commit the transaction.}
00697         $this->dbh->commit();
00698     \}
00699 
\hypertarget{Database_8php_source_l00706}{}\hyperlink{classDatabase_a19ba63b5a89bb24232cd474c54b4f731}{00706}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classDatabase_a19ba63b5a89bb24232cd474c54b4f731}{set\_image\_tags}($image\_id, $tags) \{
00707         \textcolor{comment}{// Start a database transaction.}
00708         $this->dbh->beginTransaction();
00709 
00710         \textcolor{comment}{// Delete all tags for this image.}
00711         \textcolor{keywordflow}{try} \{
00712             $sth = $this->dbh->prepare(\textcolor{stringliteral}{"DELETE FROM image\_tags WHERE
       image\_info\_id = :image\_id;"});
00713             $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00714             $sth->execute();
00715         \}
00716         \textcolor{keywordflow}{catch} (Exception $e) \{
00717             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00718         \}
00719 
00720         \textcolor{comment}{// Set the new substrate annotations.}
00721         \textcolor{keywordflow}{foreach} ( $tags as $tag ) \{
00722             \textcolor{keywordflow}{try} \{
00723                 $sth = $this->dbh->prepare(\textcolor{stringliteral}{"INSERT INTO image\_tags VALUES
       (:image\_id, :tag);"});
00724                 $sth->bindParam(\textcolor{stringliteral}{":image\_id"}, $image\_id, PDO::PARAM\_INT);
00725                 $sth->bindParam(\textcolor{stringliteral}{":tag"}, $tag, PDO::PARAM\_INT);
00726                 $sth->execute();
00727             \}
00728             \textcolor{keywordflow}{catch} (Exception $e) \{
00729                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Exception( $e->getMessage() );
00730             \}
00731         \}
00732 
00733         \textcolor{comment}{// Commit the transaction.}
00734         $this->dbh->commit();
00735     \}
00736 \}
\end{DoxyCode}
